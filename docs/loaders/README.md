
# Loaders documentation

Loaders in spetlr:

- [SCD2UpsertLoader](#SCD2Loader)
 

# SCD2UpsertLoader
*Class implemented as: ValidFromToUpsertLoader. SCD2 can potentially be implemented in many ways. This loader 
ssociates with SPETLR's existing ValidFromValidToTransformer.*

The SCD2UpsertLoader is a class designed for handling Slowly Changing Dimensions (SCD) Type 2 in PySpark dataframes. 
This loader is particularly useful in scenarios where data evolves over time, and there is a need to maintain 
historical versions of data records. It enables upserts to SCD2 tables, meaning it can both update existing records and
insert new records as needed.

The loader adds `ValidFrom`, `ValidTo`, `IsCurrent`, and `HashValue` columns to the source schema. The ValidFrom and ValidTo 
columns help in tracking the duration for which a record is valid. The IsCurrent flag indicates whether a record is the 
latest version. The HashKey is a unique identifier for each record, typically generated by hashing one or more columns of the data.

The `join_columns` are the columns that identifies specific event. The `HashValue` represents the a hash value of the events data at the specific time.
The values in the `join_columns` are therefore in the sink table non-unique. The `HashValue` is unique. 

Recommendations: Add [liquid clustering](https://docs.databricks.com/en/delta/clustering.html) to your source and sink table. 
Cluster by the `join_columns` and the `HashValue` column.

## Example
Here is an example of how the SCD2UpsertLoader can be used in a PySpark application:

First, consider a PySpark dataframe with the following schema and data:

```markdown
df.show()
+-------+------+----------+-------------------+
|Id| Col1 |   Col2   |      TimeCol      |
+-------+------+----------+-------------------+
|   1   | Fender|Telecaster|2021-07-01 10:00:00|
|   2   | Fender|Telecaster|2021-07-01 11:00:00|
|   2  | Gibson| Les Paul |2021-07-01 11:00:00|
+-------+------+----------+-------------------+
```

To apply the SCD2UpsertLoader to this dataframe:

```python
from spetlr.delta import DeltaHandle
from spetlr.etl.loaders.scd2_loader import SCD2UpsertLoader

dh = DeltaHandle(...)  # Configure the DeltaHandle with relevant parameters

# Initialize SCD2UpsertLoader with the necessary parameters
scd2_loader = SCD2UpsertLoader(
    sink_handle=dh,
    join_cols=["Id"],
    time_col="TimeCol",
    hash_value_col="HashValue"
)

# Apply the SCD2UpsertLoader to transform the dataframe
scd2_loader.save(df)

# View the transformed dataframe
df_transformed = dh.read()
df_transformed.show()


```

The resulting dataframe will have additional columns for managing the SCD2 properties:
```markdown
+-------+------+----------+-------------------+-------------------+---------+---------+-------------------------------+
|Id| Col1 |   Col2   |     TimeCol       |    ValidFrom      | ValidTo             |IsCurrent|    HashValue     |
+-------+------+----------+-------------------+-------------------+---------+---------+------------------------------+
|   1   | Fender|Telecaster|2021-07-01 10:00:00|2021-07-01 10:00:00|2021-07-01 11:00:00|  False  |<hash_value_1>      |
|   1   | Fender|Telecaster|2021-07-01 11:00:00|2021-07-01 11:00:00|max_time           |  True   |<hash_value_1>      |
|   2   | Gibson| Les Paul |2021-07-01 11:00:00|2021-07-01 11:00:00|max_time            |  True  |<hash_value_2>      |
+-------+------+----------+-------------------+-------------------+---------+---------+-------------------------------+
```

In this transformed dataframe, the SCD2UpsertLoader has added ValidFrom, ValidTo, IsCurrent, and HashValue columns to 
effectively manage the SCD2 logic for tracking changes over time.
